<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js webgl - Spherical Panorama by Leonardo Galli & Tommaso Levato</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                font-family: Monospace;
                background-color: #f0f0f0;
                margin: 0px;
                overflow: hidden;
            }
        </style>
    </head>
    <body>

        <div id="container"></div>
        <div id="info">MICC - Media Integration and Communication Center</div>

        <script type="text/javascript" src="js/three.min.js"></script>
        <script type="text/javascript" src="js/ajaxMysql.js"></script>
        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/eventListenersFacciata.js"></script>

        <script>
            //arrow helper?
            var camera, scene, renderer, mesh;
            var fov = 70,
                    plane,
                    objects = [],
                    isUserInteracting = false,
                    onMouseDownMouseX = 0, onMouseDownMouseY = 0,
                    lon = 0, onMouseDownLon = 0,
                    lat = 0, onMouseDownLat = 0,
                    phi = 0, theta = 0,
                    latLimit = -30,
                    projector,
                    minZoom = 100, maxZoom = 20,
                    interactiveObject,
                    onMouseDownObjectXRotation,
                    onMouseDownObjectYRotation,
                    onMouseDownObjectZRotation,
                    isRightClick = false;
            var manager = new THREE.LoadingManager();
            manager.onProgress = function(item, loaded, total) {
                console.log(item, loaded, total);
            };
            init();
            animate();
            function init() {

                camera = new THREE.PerspectiveCamera(fov, window.innerWidth / window.innerHeight, 1, 1100);
                camera.target = new THREE.Vector3(0, 0, 0);
                scene = new THREE.Scene();
                projector = new THREE.Projector();

//                var markerTexture = THREE.ImageUtils.loadTexture('images/Facciata.jpg');
//                var geometry = new THREE.PlaneGeometry(20, 20);
//                var material = new THREE.MeshBasicMaterial({map: markerTexture});
//                plane = new THREE.Mesh(geometry, material);
//                plane.position.set(17, 0, 0);
//                plane.lookAt(new THREE.Vector3(0, 0, 0));
//                scene.add(plane);
                var materials = [
                    new THREE.MeshLambertMaterial({
                        map: THREE.ImageUtils.loadTexture('images/FormellaCroce.jpg')
                    }),
                    new THREE.MeshLambertMaterial({
                        map: THREE.ImageUtils.loadTexture('images/FormellaCroce.jpg')
                    }),
                    new THREE.MeshLambertMaterial({
                        map: THREE.ImageUtils.loadTexture('images/FormellaCroce.jpg')
                    }),
                    new THREE.MeshLambertMaterial({
                        map: THREE.ImageUtils.loadTexture('images/FormellaCroce.jpg')
                    }),
                    new THREE.MeshLambertMaterial({
                        map: THREE.ImageUtils.loadTexture('images/FormellaCroce.jpg')
                    }),
                    new THREE.MeshLambertMaterial({
                        map: THREE.ImageUtils.loadTexture('images/FormellaCroce.jpg')
                    })
                ];
                var cube = new THREE.Mesh(
                        new THREE.CubeGeometry(10, 10, 10, 1, 1, 1),
                        new THREE.MeshFaceMaterial(materials));
                cube.position.set(17, 0, 0);
                scene.add(cube);
                objects.push(cube);


                renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);
                //shadow
                var light = new THREE.DirectionalLight(0xffffff);
                light.position.set(0, 0, 0);
                light.target.position.set(10, 0, 0);
                scene.add(light);
                //renderer.shadowMapEnabled = true;
                light.castShadow = true;
                light.shadowDarkness = 1;
                renderer.shadowMapSoft = true;
                //plane.receiveShadow = true;
                //
                document.addEventListener('contextmenu', onDocumentRightClick, false);
                document.addEventListener('mousedown', onDocumentMouseDown, false);
                document.addEventListener('mousemove', onDocumentMouseMove, false);
                document.addEventListener('mouseup', onDocumentMouseUp, false);
                document.addEventListener('mousewheel', onDocumentMouseWheel, false);
                document.addEventListener('DOMMouseScroll', onDocumentMouseWheel, false);
                document.addEventListener('dblclick', onDocumentDoubleclick, false);
                window.addEventListener('resize', onWindowResize, false);


            }
            function animate() {
                requestAnimationFrame(animate);
                render();
            }
            function render() {
                lat = Math.max(-85, Math.min(85, lat));
                phi = THREE.Math.degToRad(90 - lat);
                theta = THREE.Math.degToRad(lon);
                camera.target.x = 500 * Math.sin(phi) * Math.cos(theta);
                camera.target.y = 500 * Math.cos(phi);
                camera.target.z = 500 * Math.sin(phi) * Math.sin(theta);
                camera.lookAt(camera.target);
                renderer.render(scene, camera);
            }
            function onDocumentMouseDown(event) {
                event.preventDefault();
                if (event.which === 3) {
                    isRightClick = true;
                }
                isUserInteracting = true;
                onPointerDownPointerX = event.clientX;
                onPointerDownPointerY = event.clientY;
                onPointerDownLon = lon;
                onPointerDownLat = lat;
                var mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                var mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                var vector = new THREE.Vector3(mouseX, mouseY, 0.5);
                projector.unprojectVector(vector, camera);
                var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
                var intersects = raycaster.intersectObjects(objects, true);
                if (intersects[0] !== undefined) {
                    interactiveObject = intersects[0].object;
                    onMouseDownObjectXRotation = interactiveObject.rotation.x;
                    onMouseDownObjectYRotation = interactiveObject.rotation.y;
                    onMouseDownObjectZRotation = interactiveObject.rotation.z;
                }
            }
            function mod(num, mod) {
                var remain = num % mod;
                return Math.floor(remain >= 0 ? remain : remain + mod);
            }

        </script>