<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js webgl - Sphanorama by Leonardo Galli & Tommaso Levato</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link href="css/index.css" rel="stylesheet" type="text/css">
    </head>
    <body>

        <div id="container"></div>
        <div id="info"><a href="http://threejs.org" target="_blank">three.js webgl</a> - Sphanorama by Leonardo Galli & Tommaso Levato.</div>

        <script type="text/javascript" src="js/three.min.js"></script>
        <script type="text/javascript" src="js/OBJLoader.js"></script>
        <script type="text/javascript" src="js/MTLLoader.js"></script>
        <script type="text/javascript" src="js/OBJMTLLoader.js"></script>
        <script type="text/javascript" src="js/ajaxMysql.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

        <script>
            var camera, scene, renderer, mesh;
            var objects = [];
            var objectsPosition = [];
            var loader = new THREE.OBJMTLLoader();
            var fov = 70,
                    texture,
                    isUserInteracting = false,
                    onMouseDownMouseX = 0, onMouseDownMouseY = 0,
                    lon = 0, onMouseDownLon = 0,
                    lat = 0, onMouseDownLat = 0,
                    phi = 0, theta = 0,
                    //senza latLimit "guardando" in basso si vede un buco nero
                    latLimit = -30,
                    projector, panoId = 1,
                    minZoom = 70, maxZoom = 20;

            var fadeEffect = function() {
                return{
                    init: function(id, flag, target) {
                        this.elem = document.getElementById(id);
                        clearInterval(this.elem.si);
                        this.target = target ? target : flag ? 100 : 0;
                        this.flag = flag || -1;
                        this.alpha = this.elem.style.opacity ? parseFloat(this.elem.style.opacity) * 100 : 0;
                        this.elem.si = setInterval(function() {
                            fadeEffect.tween();
                        }, 20);
                    },
                    tween: function() {
                        if (this.alpha === this.target) {
                            clearInterval(this.elem.si);
                        } else {
                            var value = Math.round(this.alpha + ((this.target - this.alpha) * .05)) + (1 * this.flag);
                            this.elem.style.opacity = value / 100;
                            this.elem.style.filter = 'alpha(opacity=' + value + ')';
                            this.alpha = value;
                        }
                    }
                };
            }();
            init();
            animate();



            function init() {
                fadeEffect.init('container', 1);
                var container = document.getElementById('container');
                loader.addEventListener('load', function(event) {
                    var object = event.content;
                    var k = 0;
                    var found = false;
                    var length = objectsPosition.length;
                    var indice;
                    while (k < length && !found) {
                        if (objectsPosition[k]['name'] === object.name) {
                            indice = k;
                            found = true;
                        }
                        k++;
                    }
                    object.position.x = objectsPosition[indice]['x'];
                    object.position.y = objectsPosition[indice]['y'];
                    object.position.z = objectsPosition[indice]['z'];
                    scene.add(object);
                    objects.push(object);
                }, false);
                camera = new THREE.PerspectiveCamera(fov, window.innerWidth / window.innerHeight, 1, 1100);
                camera.target = new THREE.Vector3(0, 0, 0);
                scene = new THREE.Scene();
                projector = new THREE.Projector();
                getPanorama(panoId);
                var panoName = xmlhttp.responseText;
                getMedia();
                texture = THREE.ImageUtils.loadTexture('textures/' + panoName);
                mesh = new THREE.Mesh(new THREE.SphereGeometry(500, 60, 40), new THREE.MeshBasicMaterial({map: texture}));
                mesh.scale.x = -1;
                scene.add(mesh);
                var pointLight = new THREE.PointLight(0xFFFFFF);
                scene.add(pointLight);
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);
                document.addEventListener('mousedown', onDocumentMouseDown, false);
                document.addEventListener('mousemove', onDocumentMouseMove, false);
                document.addEventListener('mouseup', onDocumentMouseUp, false);
                document.addEventListener('mousewheel', onDocumentMouseWheel, false);
                document.addEventListener('DOMMouseScroll', onDocumentMouseWheel, false);
                window.addEventListener('resize', onWindowResize, false);
                renderer.domElement.addEventListener('click', function(event) {
                    event.preventDefault();
                    var mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                    var mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                    var vector = new THREE.Vector3(mouseX, mouseY, 0.5);
                    projector.unprojectVector(vector, camera);
                    var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
                    var intersects = raycaster.intersectObjects(objects, true);
                    if (intersects[0] !== undefined) {
                        var name = intersects[0].object.parent.name;
                        popUp(name);
                    }
                }, false);
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function onDocumentMouseDown(event) {
                isUserInteracting = true;
                onPointerDownPointerX = event.clientX;
                onPointerDownPointerY = event.clientY;
                onPointerDownLon = lon;
                onPointerDownLat = lat;
            }

            function onDocumentMouseMove(event) {
                if (isUserInteracting) {
                    console.log("Longitude: " + lon.toString());
                    console.log("Latitude: " + lat.toString());
                    lon = mod(((onPointerDownPointerX - event.clientX) * 0.1 + onPointerDownLon), 360);
                    var rawLat = (event.clientY - onPointerDownPointerY) * 0.1 + onPointerDownLat;
                    lat = Math.max(rawLat, latLimit);
                }
            }

            function onDocumentMouseUp(event) {
                isUserInteracting = false;
            }

            function onDocumentMouseWheel(event) {
                var sub = fov - Math.min((event.wheelDeltaY * 0.05), 2);
                if (maxZoom <= sub && sub <= minZoom) {
                    // WebKit
                    if (event.wheelDeltaY) {
                        fov -= Math.min((event.wheelDeltaY * 0.05), 2);
                        // Opera / Explorer 9
                    } else if (event.wheelDelta) {
                        fov -= Math.min((event.wheelDelta * 0.05), 2);
                        // Firefox
                    } else if (event.detail) {
                        fov += Math.min((event.detail * 1.0), 2);
                    }
                    camera.projectionMatrix.makePerspective(fov, window.innerWidth / window.innerHeight, 1, 1100);
                    render();
                }
                if (sub < maxZoom) {
                    getNextPanorama(panoId);
                    var panoArray = JSON.parse(xmlhttp.response);
                    var found = false;
                    while (panoArray.length > 0 && !found) {
                        var candidate = panoArray.pop();
                        found = isNextPano(candidate);
                    }
                    if (found) {
                        panoId = candidate['ID'];
                        fadeEffect.init('container', 0, 40);
                        setTimeout(function() {
                            texture = THREE.ImageUtils.loadTexture('textures/' + candidate['Panorama'], '', function onLoad() {
                                fov = 70;
                                mesh.material.map = texture;
                                camera.projectionMatrix.makePerspective(fov, window.innerWidth / window.innerHeight, 1, 1100);
                                lat = parseFloat(candidate['LatitudeOnLoad']);
                                lon = parseFloat(candidate['LongitudeOnLoad']);
                                render();
                                fadeEffect.init('container', 1);
                            });
                        }, 500);
                        while (objects.length > 0) {
                            var obj = objects.pop();
                            scene.remove(obj);
                        }
                        getMedia();
                    }
                }
            }

            function animate() {
                requestAnimationFrame(animate);
                render();
            }

            function render() {
                lat = Math.max(-85, Math.min(85, lat));
                phi = THREE.Math.degToRad(90 - lat);
                theta = THREE.Math.degToRad(lon);
                camera.target.x = 500 * Math.sin(phi) * Math.cos(theta);
                camera.target.y = 500 * Math.cos(phi);
                camera.target.z = 500 * Math.sin(phi) * Math.sin(theta);
                camera.lookAt(camera.target);
                renderer.render(scene, camera);
            }

            function mod(num, mod) {
                var remain = num % mod;
                return Math.floor(remain >= 0 ? remain : remain + mod);
            }

            function isNextPano(candidate) {
                return (Math.abs(lat - candidate['Latitude']) < 20 && Math.abs(lon - candidate['Longitude']) < 20);
            }

            function popUp(objectName) {
                if (document.body.lastChild.id !== 'html_popup') {
                    fadeEffect.init('container', 0, 40);
                    getText(objectName);
                    var textArray = JSON.parse(xmlhttp.response);
                    getImage(objectName);
                    var imageArray = JSON.parse(xmlhttp.response);
                    if (textArray.length !== 0) {
                        var popup = document.createElement('div');
                        popup.className = 'popup';
                        popup.id = 'html_popup';
                        var image = document.createElement('div');
                        image.className = 'descriptiveImage';
                        var imagename = imageArray.pop()['Image'].toString();
                        image.id = imagename;
                        var imageCall = '<img src=' + 'images/' + imagename + ' >';
                        image.innerHTML = imageCall;
                        var cancel = document.createElement('div');
                        cancel.className = 'cancel';
                        cancel.innerHTML = '<img src="images/button-close.png" >';
                        cancel.onclick = function() {
                            popup.parentNode.removeChild(popup);
                            fadeEffect.init('container', 1);
                        };
                        var message = document.createElement('span');
                        var textPath = textArray.pop()['Text'].toString();
                        var client = new XMLHttpRequest();
                        client.open('GET', 'texts/' + textPath);
                        client.onreadystatechange = function() {
                            message.innerHTML = client.responseText;
                        };
                        var logo = document.createElement('div');
                        logo.className = 'logoImg';
                        logo.innerHTML = '<img src="images/micc_logo.jpg" >';
                        client.send(null);
                        popup.appendChild(message);
                        popup.appendChild(cancel);
                        popup.appendChild(image);
                        popup.appendChild(logo);
                        document.body.appendChild(popup);
                    }
                }
            }

            function getMedia() {
                objectsPosition = [];
                getObject(panoId);
                var objectArray = JSON.parse(xmlhttp.response);
                var len = objectArray.length;
                var j = 0;
                while (j < len) {
                    var associatePosition = {'name': objectArray[j]['Object'],
                        'x': objectArray[j]['xPosition'],
                        'y': objectArray[j]['yPosition'],
                        'z': objectArray[j]['zPosition']
                    };
                    objectsPosition.push(associatePosition);
                    j++;
                }
                while (objectArray.length > 0) {
                    var candidate = objectArray.pop();
                    loader.load('objects/' + candidate['Object']);
                }
            }
        </script>

    </body>
</html>